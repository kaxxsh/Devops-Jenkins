pipeline {
    agent any
    environment {
        AWS_REGION = "us-west-2"
    }
    stages {
        stage('Setup') {
            steps {
                script {
                    if (env.BRANCH_NAME == 'dev') {
                        env.ENVIRONMENT = 'dev'
                    } else if (env.BRANCH_NAME == 'stage') {
                        env.ENVIRONMENT = 'stage'
                    } else if (env.BRANCH_NAME == 'prod') {
                        env.ENVIRONMENT = 'prod'
                    } else {
                        error "Invalid branch name. Use dev, stage, or prod."
                    }
                    echo "Deploying to environment: ${env.ENVIRONMENT}"
                }
            }
        }
        stage('Terraform Init') {
            steps {
                sh 'terraform init'
            }
        }
        stage('Terraform Plan') {
            steps {
                sh "terraform plan -var-file=${env.ENVIRONMENT}.tfvars"
            }
        }
        stage('Terraform Apply') {
            steps {
                sh "terraform apply -auto-approve -var-file=${env.ENVIRONMENT}.tfvars"
            }
        }
    }
    post {
        success {
            echo "Terraform deployment successful for ${env.ENVIRONMENT}"
        }
        failure {
            echo "Terraform deployment failed for ${env.ENVIRONMENT}"
        }
    }
}




// Jenkinsfile for Multistage Pipeline

// pipeline {
//     agent any
//     environment {
//         AWS_REGION = "us-west-2"
//     }
//     stages {
//         stage('Terraform Deploy') {
//             parallel {
//                 stage('Deploy to Dev') {
//                     steps {
//                         script {
//                             deployTerraform("dev")
//                         }
//                     }
//                 }
//                 stage('Deploy to Stage') {
//                     steps {
//                         script {
//                             deployTerraform("stage")
//                         }
//                     }
//                 }
//                 stage('Deploy to Prod') {
//                     steps {
//                         script {
//                             deployTerraform("prod")
//                         }
//                     }
//                 }
//             }
//         }
//     }
// }

// def deployTerraform(env) {
//     echo "Deploying to ${env}"
//     sh """
//         terraform init
//         terraform plan -var-file=${env}.tfvars
//         terraform apply -auto-approve -var-file=${env}.tfvars
//     """
// }

// variable "environment" {
//   description = "Environment name (dev, stage, prod)"
// }

// locals {
//   environment_suffix = var.environment
// }

// resource "aws_vpc" "main" {
//   cidr_block           = var.vpc_cidr
//   enable_dns_support   = true
//   enable_dns_hostnames = true
//   tags                 = { Name = "Main-VPC-${local.environment_suffix}" }
// }

// resource "aws_lb" "app_lb" {
//   name               = "app-load-balancer-${local.environment_suffix}"
//   load_balancer_type = "application"
//   subnets            = [aws_subnet.subnets["public_1"].id, aws_subnet.subnets["public_2"].id]

//   tags = { Name = "App-Load-Balancer-${local.environment_suffix}" }
// }