pipeline {
    agent any
    environment {
        AWS_REGION = "us-west-2"
    }
    stages {
        stage('Setup') {
            steps {
                script {
                    // Map environment name based on the branch
                    def envMap = ['dev': 'dev', 'stage': 'stage', 'prod': 'prod']
                    env.ENVIRONMENT = envMap.get(env.BRANCH_NAME, 'invalid')

                    if (env.ENVIRONMENT == 'invalid') {
                        error "Invalid branch name: ${env.BRANCH_NAME}. Use 'dev', 'stage', or 'prod'."
                    }
                    echo "Deploying to environment: ${env.ENVIRONMENT}"
                }
            }
        }
        stage('Terraform Init') {
            steps {
                sh 'terraform init'
            }
        }
        stage('Terraform Plan') {
            steps {
                sh "terraform plan -var-file=${env.ENVIRONMENT}.tfvars"
            }
        }
        stage('Terraform Apply') {
            steps {
                sh "terraform apply -auto-approve -var-file=${env.ENVIRONMENT}.tfvars"
            }
        }
    }
    post {
        success {
            echo "Terraform deployment successful for ${env.ENVIRONMENT}"
        }
        failure {
            echo "Terraform deployment failed for ${env.ENVIRONMENT}"
        }
    }
}